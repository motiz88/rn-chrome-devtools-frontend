{"version":3,"file":"UsedPreloadingView.js","sourceRoot":"","sources":["../../../../../../../../front_end/panels/application/preloading/components/UsedPreloadingView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as i18n from '../../../../core/i18n/i18n.js';\nimport {assertNotNullOrUndefined} from '../../../../core/platform/platform.js';\nimport * as SDK from '../../../../core/sdk/sdk.js';\nimport * as Protocol from '../../../../generated/protocol.js';\nimport * as ComponentHelpers from '../../../../ui/components/helpers/helpers.js';\nimport * as LegacyWrapper from '../../../../ui/components/legacy_wrapper/legacy_wrapper.js';\nimport * as Coordinator from '../../../../ui/components/render_coordinator/render_coordinator.js';\nimport * as ReportView from '../../../../ui/components/report_view/report_view.js';\nimport * as LitHtml from '../../../../ui/lit-html/lit-html.js';\n\nimport type * as Platform from '../../../../core/platform/platform.js';\n\nimport type * as UI from '../../../../ui/legacy/legacy.js';\n\nimport {prefetchFailureReason, prerenderFailureReason} from './PreloadingString.js';\n\nconst UIStrings = {\n  /**\n   *@description Title for the panel\n   */\n  preloadingUsedForThisPage: 'Preloading used for this page',\n  /**\n   *@description Label for failure reason of preloeading\n   */\n  detailsFailureReason: 'Failure reason',\n  /**\n   *@description Message that tells this page was prerendered.\n   */\n  downgradedPrefetchUsed:\n      'The initiating page attempted to prerender this page\\'s URL. The prerender failed, but the resulting response body was still used as a prefetch.',\n  /**\n   *@description Message that tells this page was prefetched.\n   */\n  prefetchUsed: 'This page was successfully prefetched.',\n  /**\n   *@description Message that tells this page was prerendered.\n   */\n  prerenderUsed: 'This page was successfully prerendered.',\n  /**\n   *@description Message that tells this page was prefetched.\n   */\n  prefetchFailed:\n      'The initiating page attempted to prefetch this page\\'s URL, but the prefetch failed, so a full navigation was performed instead.',\n  /**\n   *@description Message that tells this page was prerendered.\n   */\n  prerenderFailed:\n      'The initiating page attempted to prerender this page\\'s URL, but the prerender failed, so a full navigation was performed instead.',\n  /**\n   *@description Message that tells this page was not preloaded.\n   */\n  noPreloads: 'The initiating page did not attempt to preload this page\\'s URL.',\n};\nconst str_ = i18n.i18n.registerUIStrings('panels/application/preloading/components/UsedPreloadingView.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nconst coordinator = Coordinator.RenderCoordinator.RenderCoordinator.instance();\n\nexport interface UsedPreloadingViewData {\n  pageURL: Platform.DevToolsPath.UrlString;\n  attempts: SDK.PreloadingModel.PreloadingAttempt[];\n}\n\n// TODO(crbug.com/1167717): Make this a const enum again\n// eslint-disable-next-line rulesdir/const_enum\nexport enum UsedKind {\n  DowngradedPrerenderToPrefetchAndUsed = 'DowngradedPrerenderToPrefetchAndUsed',\n  PrefetchUsed = 'PrefetchUsed',\n  PrerenderUsed = 'PrerenderUsed',\n  PrefetchFailed = 'PrefetchFailed',\n  PrerenderFailed = 'PrerenderFailed',\n  NoPreloads = 'NoPreloads',\n}\n\nexport class UsedPreloadingView extends LegacyWrapper.LegacyWrapper.WrappableComponent<UI.Widget.VBox> {\n  static readonly litTagName = LitHtml.literal`devtools-resources-used-preloading-view`;\n\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  #data: UsedPreloadingViewData = {\n    pageURL: '' as Platform.DevToolsPath.UrlString,\n    attempts: [],\n  };\n\n  connectedCallback(): void {\n    this.#shadow.adoptedStyleSheets = [];\n  }\n\n  set data(data: UsedPreloadingViewData) {\n    this.#data = data;\n    void this.#render();\n  }\n\n  async #render(): Promise<void> {\n    await coordinator.write('UsedPreloadingView render', () => {\n      LitHtml.render(this.#renderInternal(), this.#shadow, {host: this});\n    });\n  }\n\n  #renderInternal(): LitHtml.LitTemplate {\n    const forThisPage = this.#data.attempts.filter(attempt => attempt.key.url === this.#data.pageURL);\n    const prefetch =\n        forThisPage.filter(attempt => attempt.key.action === Protocol.Preload.SpeculationAction.Prefetch)[0];\n    const prerender =\n        forThisPage.filter(attempt => attempt.key.action === Protocol.Preload.SpeculationAction.Prerender)[0];\n\n    let kind = UsedKind.NoPreloads;\n    // Prerender -> prefetch downgrade case\n    //\n    // This code does not handle the case SpecRules designate these preloads rather than prerenderer automatically downgrade prerendering.\n    // TODO(https://crbug.com/1410709): Improve this logic once automatic downgrade implemented.\n    if (prerender?.status === SDK.PreloadingModel.PreloadingStatus.Failure &&\n        prefetch?.status === SDK.PreloadingModel.PreloadingStatus.Success) {\n      kind = UsedKind.DowngradedPrerenderToPrefetchAndUsed;\n    } else if (prefetch?.status === SDK.PreloadingModel.PreloadingStatus.Success) {\n      kind = UsedKind.PrefetchUsed;\n    } else if (prerender?.status === SDK.PreloadingModel.PreloadingStatus.Success) {\n      kind = UsedKind.PrerenderUsed;\n    } else if (prefetch?.status === SDK.PreloadingModel.PreloadingStatus.Failure) {\n      kind = UsedKind.PrefetchFailed;\n    } else if (prerender?.status === SDK.PreloadingModel.PreloadingStatus.Failure) {\n      kind = UsedKind.PrerenderFailed;\n    } else {\n      kind = UsedKind.NoPreloads;\n    }\n\n    let basicMessage;\n    switch (kind) {\n      case UsedKind.DowngradedPrerenderToPrefetchAndUsed:\n        basicMessage = i18nString(UIStrings.downgradedPrefetchUsed);\n        break;\n      case UsedKind.PrefetchUsed:\n        basicMessage = i18nString(UIStrings.prefetchUsed);\n        break;\n      case UsedKind.PrerenderUsed:\n        basicMessage = i18nString(UIStrings.prerenderUsed);\n        break;\n      case UsedKind.PrefetchFailed:\n        basicMessage = i18nString(UIStrings.prefetchFailed);\n        break;\n      case UsedKind.PrerenderFailed:\n        basicMessage = i18nString(UIStrings.prerenderFailed);\n        break;\n      case UsedKind.NoPreloads:\n        basicMessage = i18nString(UIStrings.noPreloads);\n        break;\n    }\n\n    let maybeFailureReasonMessage;\n    if (kind === UsedKind.PrefetchFailed) {\n      assertNotNullOrUndefined(prefetch);\n      maybeFailureReasonMessage = prefetchFailureReason(prefetch as SDK.PreloadingModel.PrefetchAttempt);\n    } else if (kind === UsedKind.PrerenderFailed || kind === UsedKind.DowngradedPrerenderToPrefetchAndUsed) {\n      assertNotNullOrUndefined(prerender);\n      maybeFailureReasonMessage = prerenderFailureReason(prerender as SDK.PreloadingModel.PrerenderAttempt);\n    }\n\n    let maybeFailureReason: LitHtml.LitTemplate = LitHtml.nothing;\n    if (maybeFailureReasonMessage !== undefined) {\n      // Disabled until https://crbug.com/1079231 is fixed.\n      // clang-format off\n      maybeFailureReason = LitHtml.html`\n        <${ReportView.ReportView.ReportSection.litTagName}>\n          <${ReportView.ReportView.ReportKey.litTagName}>${i18nString(UIStrings.detailsFailureReason)}</${\n            ReportView.ReportView.ReportKey.litTagName}>\n          <${ReportView.ReportView.ReportValue.litTagName}>\n            ${maybeFailureReasonMessage}\n          </${ReportView.ReportView.ReportValue.litTagName}>\n        </${ReportView.ReportView.ReportSection.litTagName}>\n      `;\n      // clang-format on\n    }\n\n    // Disabled until https://crbug.com/1079231 is fixed.\n    // clang-format off\n    return LitHtml.html`\n      <${ReportView.ReportView.Report.litTagName} .data=${\n          {reportTitle: i18nString(UIStrings.preloadingUsedForThisPage)} as ReportView.ReportView.ReportData\n      }>\n        <${ReportView.ReportView.ReportSection.litTagName}>\n          ${basicMessage}\n        </${ReportView.ReportView.ReportSection.litTagName}>\n\n        ${maybeFailureReason}\n      </${ReportView.ReportView.Report.litTagName}>\n    `;\n    // clang-format on\n  }\n}\n\nComponentHelpers.CustomElements.defineComponent('devtools-resources-used-preloading-view', UsedPreloadingView);\n\ndeclare global {\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  interface HTMLElementTagNameMap {\n    'devtools-resources-used-preloading-view': UsedPreloadingView;\n  }\n}\n"]}